{"version":3,"sources":["../src/calcsetup.js"],"names":["pageurl","init","url","document","getElementById","addEventListener","showFormattedCalc","changeRule","itemChanged","e","target","getAttribute","changeCategory","innerHTML","sel","selectedOptions","cat","value","location","contents","itemid","dataset","id","courseid","ModalFactory","create","type","types","SAVE_CANCEL","body","title","Str","get_string","removeOnClose","then","modal","getRoot","on","ModalEvents","save","evt","textarea","isDefaultPrevented","Ajax","call","methodname","args","done","data","valid","replace","hide","previousElementSibling","remove","s","warning","createElement","parentNode","setAttribute","insertBefore","fail","Notification","exception","hidden","show","preventDefault","ruleid","actionurl","showrule","submit","Templates","renderForPromise","html","js","appendNodeContents","catch","d","description"],"mappings":"kiBAsBA,OACA,OACA,OACA,OACA,OACA,uD,yiBAEIA,CAAAA,CAAO,CAAG,E,QACM,QAAPC,CAAAA,IAAO,CAACC,CAAD,CAAS,CACzBF,CAAO,CAAGE,CAAV,CACAC,QAAQ,CAACC,cAAT,CAAwB,aAAxB,EAAuCC,gBAAvC,CAAwD,OAAxD,CAAiEC,CAAjE,EACAH,QAAQ,CAACC,cAAT,CAAwB,iBAAxB,EAA2CC,gBAA3C,CAA4D,OAA5D,CAAqEE,CAArE,EACAJ,QAAQ,CAACC,cAAT,CAAwB,kBAAxB,EAA4CC,gBAA5C,CAA6D,QAA7D,CAAuEG,CAAvE,CACH,C,IAEKA,CAAAA,CAAW,CAAG,SAACC,CAAD,CAAO,CACvB,GAAoC,aAAhC,GAAAA,CAAC,CAACC,MAAF,CAASC,YAAT,CAAsB,IAAtB,CAAJ,CAAmD,CAC/CC,CAAc,CAACH,CAAD,CACjB,CAFD,IAEO,CACHN,QAAQ,CAACC,cAAT,CAAwB,aAAxB,EAAuCS,SAAvC,CAAmD,gEACtD,CACJ,C,CAEKD,CAAc,CAAG,SAACH,CAAD,CAAO,IACtBK,CAAAA,CAAG,CAAGL,CAAC,CAACC,MAAF,CAASK,eADO,CAEtBC,CAAG,CAAGF,CAAG,CAAC,CAAD,CAAH,CAAOG,KAFS,CAG1Bd,QAAQ,CAACe,QAAT,CAAoBlB,CAAO,CAAG,SAAV,CAAsBgB,CAC7C,C,CAEKV,CAAiB,CAAG,SAACG,CAAD,CAAO,IACzBU,CAAAA,CAAQ,CAAGV,CAAC,CAACC,MAAF,CAASG,SADK,CAEzBO,CAAM,CAAGX,CAAC,CAACC,MAAF,CAASW,OAAT,CAAiBC,EAFD,CAGzBC,CAAQ,CAAGd,CAAC,CAACC,MAAF,CAASW,OAAT,CAAiBE,QAHH,CAI7B,MAAOC,CAAAA,CAAY,CAACC,MAAb,CAAoB,CACvBC,IAAI,CAAEF,CAAY,CAACG,KAAb,CAAmBC,WADF,CAEvBC,IAAI,CAAE,kDAAoDV,CAApD,CAA+D,aAF9C,CAGvBW,KAAK,CAAEC,CAAG,CAACC,UAAJ,CAAe,aAAf,CAA8B,uBAA9B,CAHgB,CAIvBC,aAAa,GAJU,CAApB,EAKJC,IALI,CAKC,SAASC,CAAT,CAAgB,CAEpBA,CAAK,CAACC,OAAN,GAAgBC,EAAhB,CAAmBC,CAAW,CAACC,IAA/B,CAAqC,SAASC,CAAT,CAAc,CAC/C,GAAIC,CAAAA,CAAQ,CAAGtC,QAAQ,CAACC,cAAT,CAAwB,cAAxB,CAAf,CACAoC,CAAG,CAACE,kBAAJ,CAAyB,UAAW,CAAE,QAAc,CAApD,CAEAC,CAAI,CAACC,IAAL,CAAU,CAAC,CACPC,UAAU,CAAE,oCADL,CAEPC,IAAI,CAAE,CAAC,GAAM1B,CAAP,CACF,SAAYG,CADV,CAEF,QAAWkB,CAAQ,CAACxB,KAFlB,CAFC,CAMP8B,IAAI,CAAE,cAASC,CAAT,CAAe,CACjB,GAAI,KAAAA,CAAI,CAACC,KAAT,CAAyB,CAErB9C,QAAQ,CAACC,cAAT,CAAwB,aAAxB,EAAuCS,SAAvC,CAAmD4B,CAAQ,CAACxB,KAA5D,CACAd,QAAQ,CAACC,cAAT,CAAwB,SAAxB,EAAmCa,KAAnC,CAA2CwB,CAAQ,CAACxB,KAAT,CAAeiC,OAAf,CAAuB,KAAvB,CAA8B,EAA9B,CAA3C,CACAf,CAAK,CAACgB,IAAN,EACH,CALD,IAKO,CAEH,GAAwC,IAApC,GAAAV,CAAQ,CAACW,sBAAb,CAA8C,CACvCX,CAAQ,CAACW,sBAAT,CAAgCC,MAAhC,EACN,CACDtB,CAAG,CAACC,UAAJ,CAAe,cAAf,CAA+B,uBAA/B,EAAwDE,IAAxD,CACI,SAASoB,CAAT,CAAY,IACJC,CAAAA,CAAO,CAAGpD,QAAQ,CAACqD,aAAT,CAAuB,GAAvB,CADN,CAEJ3B,CAAI,CAAGY,CAAQ,CAACgB,UAFZ,CAGRF,CAAO,CAACG,YAAR,CAAqB,OAArB,CAA8B,UAA9B,EACAH,CAAO,CAAC1C,SAAR,CAAoByC,CAApB,CACAzB,CAAI,CAAC8B,YAAL,CAAkBJ,CAAlB,CAA2Bd,CAA3B,EACA,QACH,CARL,CAUH,CACJ,CA5BM,CA6BPmB,IAAI,CAAEC,UAAaC,SA7BZ,CAAD,CAAV,CAgCH,CApCD,EAsCA3B,CAAK,CAACC,OAAN,GAAgBC,EAAhB,CAAmBC,CAAW,CAACyB,MAA/B,CAAuC,UAAW,CAC9C,GAAItB,CAAAA,CAAQ,CAAGtC,QAAQ,CAACC,cAAT,CAAwB,cAAxB,CAAf,CACAqC,CAAQ,CAACY,MAAT,EACH,CAHD,EAIAlB,CAAK,CAAC6B,IAAN,GACA,MAAO7B,CAAAA,CACV,CAnDM,CAoDV,C,CAEK5B,CAAU,CAAG,SAACiC,CAAD,CAAS,CACxBA,CAAG,CAACyB,cAAJ,GADwB,GAEpBC,CAAAA,CAAM,CAAG1B,CAAG,CAAC9B,MAAJ,CAAWW,OAAX,CAAmB6C,MAAnB,EAA6B,CAFlB,CAGpBC,CAAS,CAAG3B,CAAG,CAAC9B,MAAJ,CAAWC,YAAX,CAAwB,MAAxB,CAHQ,CAKxB,MAAOa,CAAAA,CAAY,CAACC,MAAb,CAAoB,CACvBC,IAAI,CAAEF,CAAY,CAACG,KAAb,CAAmBC,WADF,CAEvBC,IAAI,CAAE,EAFiB,CAGvBC,KAAK,CAAEC,CAAG,CAACC,UAAJ,CAAe,MAAf,CAAuB,uBAAvB,CAHgB,CAIvBC,aAAa,GAJU,CAApB,EAKJC,IALI,CAKC,SAASC,CAAT,CAAgB,CACpBA,CAAK,CAACA,KAAN,CAAY,CAAZ,EAAe9B,gBAAf,CAAgC,QAAhC,CAA0C+D,CAA1C,EACAjC,CAAK,CAACC,OAAN,GAAgBC,EAAhB,CAAmBC,CAAW,CAACC,IAA/B,CAAqC,UAAW,CAC5CpC,QAAQ,CAACC,cAAT,CAAwB,kBAAxB,EAA4CiE,MAA5C,EACH,CAFD,EAIA1B,CAAI,CAACC,IAAL,CAAU,CAAC,CACPC,UAAU,CAAE,gCADL,CAEPC,IAAI,CAAE,CACF,GAAMoB,CADJ,CAFC,CAKPnB,IAAI,CAAE,cAASC,CAAT,CAAe,CACjBA,CAAI,CAACmB,SAAL,CAAiBA,CAAjB,CACAG,CAAS,CAACC,gBAAV,CAA2B,oCAA3B,CAAiEvB,CAAjE,EACCd,IADD,CACM,WAAgB,IAAdsC,CAAAA,CAAc,GAAdA,IAAc,CAARC,CAAQ,GAARA,EAAQ,CAClBH,CAAS,CAACI,kBAAV,CAA6B,aAA7B,CAA4CF,CAA5C,CAAkDC,CAAlD,EACA,QACH,CAJD,EAKCE,KALD,CAKOd,UAAaC,SALpB,CAMH,CAbM,CAAD,CAAV,EAeA3B,CAAK,CAAC6B,IAAN,GACA,QACH,CA5BM,CA6BV,C,CAEKI,CAAQ,CAAG,SAAC3D,CAAD,CAAO,CACpB,GAAImE,CAAAA,CAAC,CAAGnE,CAAC,CAACC,MAAF,CAASW,OAAT,CAAiBwD,WAAzB,CACA1E,QAAQ,CAACC,cAAT,CAAwB,iBAAxB,EAA2CS,SAA3C,CAAuD+D,CAC1D,C","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * @file       UI scripts for Grade Calculation Setup Tool.\n * @copyright  Te Wānanga o Aotearoa\n * @author     Jeremy FitzPatrick\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport * as Ajax from 'core/ajax';\nimport * as ModalFactory from 'core/modal_factory';\nimport * as ModalEvents from 'core/modal_events';\nimport * as Str from 'core/str';\nimport * as Templates from 'core/templates';\nimport Notification from 'core/notification';\n\nlet pageurl = '';\nexport const init = (url) => {\n    pageurl = url;\n    document.getElementById('newcalcview').addEventListener('click', showFormattedCalc);\n    document.getElementById('changertherules').addEventListener('click', changeRule);\n    document.getElementById('categoryitemform').addEventListener('change', itemChanged);\n};\n\nconst itemChanged = (e) => {\n    if (e.target.getAttribute('id') === 'catselector') {\n        changeCategory(e);\n    } else {\n        document.getElementById('newcalcview').innerHTML = \"The data may have changed. Save the items or refresh the page.\";\n    }\n};\n\nconst changeCategory = (e) => {\n    let sel = e.target.selectedOptions;\n    let cat = sel[0].value;\n    document.location = pageurl + \"&catid=\" + cat;\n};\n\nconst showFormattedCalc = (e) => {\n    let contents = e.target.innerHTML;\n    let itemid = e.target.dataset.id;\n    let courseid = e.target.dataset.courseid;\n    return ModalFactory.create({\n        type: ModalFactory.types.SAVE_CANCEL,\n        body: \"<textarea class='calc-input' id='modifiedcalc'>\" + contents + \"</textarea>\",\n        title: Str.get_string('calculation', 'gradereport_calcsetup'),\n        removeOnClose: true\n    }).then(function(modal) {\n        // Handle save event.\n        modal.getRoot().on(ModalEvents.save, function(evt) {\n            let textarea = document.getElementById('modifiedcalc');\n            evt.isDefaultPrevented = function() { return true; };\n            // Validate the formula.\n            Ajax.call([{\n                methodname: 'gradereport_calcsetup_validatecalc',\n                args: {'id': itemid,\n                    'courseid': courseid,\n                    'formula': textarea.value\n                },\n                done: function(data) {\n                    if (data.valid === true) {\n                        // Apply changes and close dialog.\n                        document.getElementById('newcalcview').innerHTML = textarea.value;\n                        document.getElementById('newcalc').value = textarea.value.replace(/\\n/g, '');\n                        modal.hide();\n                    } else {\n                        // Warn of errors and leave dialog open.\n                        if (textarea.previousElementSibling !== null) {\n                               textarea.previousElementSibling.remove();\n                        }\n                        Str.get_string('formulaerror', 'gradereport_calcsetup').then(\n                            function(s) {\n                                let warning = document.createElement(\"p\");\n                                let body = textarea.parentNode;\n                                warning.setAttribute('class', 'bad-calc');\n                                warning.innerHTML = s;\n                                body.insertBefore(warning, textarea);\n                                return true;\n                            }\n                        );\n                    }\n                },\n                fail: Notification.exception\n            }]);\n\n        });\n\n        modal.getRoot().on(ModalEvents.hidden, function() {\n            let textarea = document.getElementById('modifiedcalc');\n            textarea.remove();\n        });\n        modal.show();\n        return modal;\n    });\n};\n\nconst changeRule = (evt) => {\n    evt.preventDefault();\n    let ruleid = evt.target.dataset.ruleid || 0;\n    let actionurl = evt.target.getAttribute(\"href\");\n\n    return ModalFactory.create({\n        type: ModalFactory.types.SAVE_CANCEL,\n        body: \"\",\n        title: Str.get_string('rule', 'gradereport_calcsetup'),\n        removeOnClose: true\n    }).then(function(modal) {\n        modal.modal[0].addEventListener('change', showrule);\n        modal.getRoot().on(ModalEvents.save, function() {\n            document.getElementById('categoryruleform').submit();\n        });\n\n        Ajax.call([{\n            methodname: 'gradereport_calcsetup_getrules',\n            args: {\n                'id': ruleid\n            },\n            done: function(data) {\n                data.actionurl = actionurl;\n                Templates.renderForPromise('gradereport_calcsetup/ruleselector', data)\n                .then(({html, js}) => {\n                    Templates.appendNodeContents('.modal-body', html, js);\n                    return true;\n                })\n                .catch(Notification.exception);\n            }\n        }]);\n        modal.show();\n        return true;\n    });\n};\n\nconst showrule = (e) => {\n    let d = e.target.dataset.description;\n    document.getElementById(\"ruledescription\").innerHTML = d;\n};\n"],"file":"calcsetup.min.js"}