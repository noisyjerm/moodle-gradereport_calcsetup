{"version":3,"file":"calcsetup.min.js","sources":["../src/calcsetup.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * @file       UI scripts for Grade Calculation Setup Tool.\n * @copyright  Te Wānanga o Aotearoa\n * @author     Jeremy FitzPatrick\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport * as Ajax from 'core/ajax';\nimport * as ModalFactory from 'core/modal_factory';\nimport * as ModalEvents from 'core/modal_events';\nimport * as Str from 'core/str';\nimport * as Templates from 'core/templates';\nimport Notification from 'core/notification';\n\nlet pageurl = '';\nlet ruleSelector = false;\nexport const init = (url) => {\n    pageurl = url;\n    document.getElementById('newcalcview').addEventListener('click', showFormattedCalc);\n    document.getElementById('changertherules').addEventListener('click', changeRule);\n    document.getElementById('categoryitemform').addEventListener('change', itemChanged);\n};\n\nconst itemChanged = (e) => {\n    if (e.target.getAttribute('id') === 'catselector') {\n        changeCategory(e);\n    } else {\n        document.getElementById('newcalcview').innerHTML = \"The data may have changed. Save the items or refresh the page.\";\n    }\n};\n\nconst changeCategory = (e) => {\n    let sel = e.target.selectedOptions;\n    let cat = sel[0].value;\n    document.location = pageurl + \"&catid=\" + cat;\n};\n\nconst showFormattedCalc = (e) => {\n    let contents = e.target.innerHTML;\n    let itemid = e.target.dataset.id;\n    let courseid = e.target.dataset.courseid;\n    return ModalFactory.create({\n        type: ModalFactory.types.SAVE_CANCEL,\n        body: \"<textarea class='calc-input' id='modifiedcalc'>\" + contents + \"</textarea>\",\n        title: Str.get_string('calculation', 'gradereport_calcsetup'),\n        removeOnClose: true\n    }).then(function(modal) {\n        // Handle save event.\n        modal.getRoot().on(ModalEvents.save, function(evt) {\n            let textarea = document.getElementById('modifiedcalc');\n            evt.isDefaultPrevented = function() {\n                return true;\n            };\n            // Validate the formula.\n            Ajax.call([{\n                methodname: 'gradereport_calcsetup_validatecalc',\n                args: {'id': itemid,\n                    'courseid': courseid,\n                    'formula': textarea.value\n                },\n                done: function(data) {\n                    if (data.valid === true) {\n                        // Apply changes and close dialog.\n                        document.getElementById('newcalcview').innerHTML = textarea.value;\n                        document.getElementById('newcalc').value = textarea.value.replace(/\\n/g, '');\n                        modal.hide();\n                    } else {\n                        // Warn of errors and leave dialog open.\n                        if (textarea.previousElementSibling !== null) {\n                               textarea.previousElementSibling.remove();\n                        }\n                        Str.get_string('formulaerror', 'gradereport_calcsetup').then(\n                            function(s) {\n                                let warning = document.createElement(\"p\");\n                                let body = textarea.parentNode;\n                                warning.setAttribute('class', 'bad-calc');\n                                warning.innerHTML = s;\n                                body.insertBefore(warning, textarea);\n                                return true;\n                            }\n                        ).fail(Notification.exception);\n                    }\n                },\n                fail: Notification.exception\n            }]);\n\n        });\n\n        modal.getRoot().on(ModalEvents.hidden, function() {\n            let textarea = document.getElementById('modifiedcalc');\n            textarea.remove();\n        });\n        modal.show();\n        return modal;\n    });\n};\n\nconst changeRule = (evt) => {\n    evt.preventDefault();\n    let ruleid = evt.target.dataset.ruleid || 0;\n    let actionurl = evt.target.getAttribute(\"href\");\n\n    if (ruleSelector) {\n        ruleSelector.show();\n    } else {\n        return ModalFactory.create({\n            type: ModalFactory.types.SAVE_CANCEL,\n            body: \"\",\n            title: Str.get_string('rule', 'gradereport_calcsetup'),\n            removeOnClose: false\n        }).then(function (modal) {\n            ruleSelector = modal;\n            modal.modal[0].addEventListener('change', showrule);\n            modal.getRoot().on(ModalEvents.save, function () {\n                document.getElementById('categoryruleform').submit();\n            });\n\n            Ajax.call([{\n                methodname: 'gradereport_calcsetup_getrules',\n                args: {\n                    'id': ruleid\n                },\n                done: function (data) {\n                    data.actionurl = actionurl;\n                    Templates.renderForPromise('gradereport_calcsetup/ruleselector', data)\n                        .then(({html, js}) => {\n                            Templates.appendNodeContents('.modal-body', html, js);\n                            return true;\n                        })\n                        .catch(Notification.exception);\n                }\n            }]);\n            modal.show();\n            return true;\n        });\n    }\n};\n\nconst showrule = (evt) => {\n    let d = evt.target.dataset.description;\n    document.getElementById(\"ruledescription\").innerHTML = d;\n};\n"],"names":["pageurl","ruleSelector","url","document","getElementById","addEventListener","showFormattedCalc","changeRule","itemChanged","e","target","getAttribute","changeCategory","innerHTML","cat","selectedOptions","value","location","contents","itemid","dataset","id","courseid","ModalFactory","create","type","types","SAVE_CANCEL","body","title","Str","get_string","removeOnClose","then","modal","getRoot","on","ModalEvents","save","evt","textarea","isDefaultPrevented","Ajax","call","methodname","args","done","data","valid","replace","hide","previousElementSibling","remove","s","warning","createElement","parentNode","setAttribute","insertBefore","fail","Notification","exception","hidden","show","preventDefault","ruleid","actionurl","showrule","submit","Templates","renderForPromise","html","js","appendNodeContents","catch","d","description"],"mappings":";;;;;;+WA6BIA,QAAU,GACVC,cAAe,gBACC,SAACC,KACjBF,QAAUE,IACVC,SAASC,eAAe,eAAeC,iBAAiB,QAASC,mBACjEH,SAASC,eAAe,mBAAmBC,iBAAiB,QAASE,YACrEJ,SAASC,eAAe,oBAAoBC,iBAAiB,SAAUG,kBAGrEA,YAAc,SAACC,GACmB,gBAAhCA,EAAEC,OAAOC,aAAa,MACtBC,eAAeH,GAEfN,SAASC,eAAe,eAAeS,UAAY,kEAIrDD,eAAiB,SAACH,OAEhBK,IADML,EAAEC,OAAOK,gBACL,GAAGC,MACjBb,SAASc,SAAWjB,QAAU,UAAYc,KAGxCR,kBAAoB,SAACG,OACnBS,SAAWT,EAAEC,OAAOG,UACpBM,OAASV,EAAEC,OAAOU,QAAQC,GAC1BC,SAAWb,EAAEC,OAAOU,QAAQE,gBACzBC,aAAaC,OAAO,CACvBC,KAAMF,aAAaG,MAAMC,YACzBC,KAAM,kDAAoDV,SAAW,cACrEW,MAAOC,IAAIC,WAAW,cAAe,yBACrCC,eAAe,IAChBC,MAAK,SAASC,cAEbA,MAAMC,UAAUC,GAAGC,YAAYC,MAAM,SAASC,SACtCC,SAAWrC,SAASC,eAAe,gBACvCmC,IAAIE,mBAAqB,kBACd,GAGXC,KAAKC,KAAK,CAAC,CACPC,WAAY,qCACZC,KAAM,IAAO1B,gBACGG,iBACDkB,SAASxB,OAExB8B,KAAM,SAASC,OACQ,IAAfA,KAAKC,OAEL7C,SAASC,eAAe,eAAeS,UAAY2B,SAASxB,MAC5Db,SAASC,eAAe,WAAWY,MAAQwB,SAASxB,MAAMiC,QAAQ,MAAO,IACzEf,MAAMgB,SAGkC,OAApCV,SAASW,wBACNX,SAASW,uBAAuBC,SAEvCtB,IAAIC,WAAW,eAAgB,yBAAyBE,MACpD,SAASoB,OACDC,QAAUnD,SAASoD,cAAc,KACjC3B,KAAOY,SAASgB,kBACpBF,QAAQG,aAAa,QAAS,YAC9BH,QAAQzC,UAAYwC,EACpBzB,KAAK8B,aAAaJ,QAASd,WACpB,KAEbmB,KAAKC,sBAAaC,aAG5BF,KAAMC,sBAAaC,gBAK3B3B,MAAMC,UAAUC,GAAGC,YAAYyB,QAAQ,WACpB3D,SAASC,eAAe,gBAC9BgD,YAEblB,MAAM6B,OACC7B,UAIT3B,WAAa,SAACgC,KAChBA,IAAIyB,qBACAC,OAAS1B,IAAI7B,OAAOU,QAAQ6C,QAAU,EACtCC,UAAY3B,IAAI7B,OAAOC,aAAa,YAEpCV,oBAGOsB,aAAaC,OAAO,CACvBC,KAAMF,aAAaG,MAAMC,YACzBC,KAAM,GACNC,MAAOC,IAAIC,WAAW,OAAQ,yBAC9BC,eAAe,IAChBC,MAAK,SAAUC,cACdjC,aAAeiC,MACfA,MAAMA,MAAM,GAAG7B,iBAAiB,SAAU8D,UAC1CjC,MAAMC,UAAUC,GAAGC,YAAYC,MAAM,WACjCnC,SAASC,eAAe,oBAAoBgE,YAGhD1B,KAAKC,KAAK,CAAC,CACPC,WAAY,iCACZC,KAAM,IACIoB,QAEVnB,KAAM,SAAUC,MACZA,KAAKmB,UAAYA,UACjBG,UAAUC,iBAAiB,qCAAsCvB,MAC5Dd,MAAK,mBAAEsC,UAAAA,KAAMC,QAAAA,UACVH,UAAUI,mBAAmB,cAAeF,KAAMC,KAC3C,KAEVE,MAAMd,sBAAaC,eAGhC3B,MAAM6B,QACC,KA9BX9D,aAAa8D,QAmCfI,SAAW,SAAC5B,SACVoC,EAAIpC,IAAI7B,OAAOU,QAAQwD,YAC3BzE,SAASC,eAAe,mBAAmBS,UAAY8D"}