define("gradereport_calcsetup/calcsetup",["exports","core/ajax","core/modal_factory","core/modal_events","core/str","core/templates","core/notification"],(function(_exports,Ajax,ModalFactory,ModalEvents,Str,Templates,_notification){var obj;function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}return newObj.default=obj,cache&&cache.set(obj,newObj),newObj}
/**
   * @file       UI scripts for Grade Calculation Setup Tool.
   * @copyright  Te Wānanga o Aotearoa
   * @author     Jeremy FitzPatrick
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,Ajax=_interopRequireWildcard(Ajax),ModalFactory=_interopRequireWildcard(ModalFactory),ModalEvents=_interopRequireWildcard(ModalEvents),Str=_interopRequireWildcard(Str),Templates=_interopRequireWildcard(Templates),_notification=(obj=_notification)&&obj.__esModule?obj:{default:obj};let pageurl="";_exports.init=url=>{pageurl=url,document.getElementById("newcalcview").addEventListener("click",showFormattedCalc),document.getElementById("changertherules").addEventListener("click",changeRule),document.getElementById("categoryitemform").addEventListener("change",itemChanged)};const itemChanged=e=>{"catselector"===e.target.getAttribute("id")?changeCategory(e):document.getElementById("newcalcview").innerHTML="The data may have changed. Save the items or refresh the page."},changeCategory=e=>{let cat=e.target.selectedOptions[0].value;document.location=pageurl+"&catid="+cat},showFormattedCalc=e=>{let contents=e.target.innerHTML,itemid=e.target.dataset.id,courseid=e.target.dataset.courseid;return ModalFactory.create({type:ModalFactory.types.SAVE_CANCEL,body:"<textarea class='calc-input' id='modifiedcalc'>"+contents+"</textarea>",title:Str.get_string("calculation","gradereport_calcsetup"),removeOnClose:!0}).then((function(modal){return modal.getRoot().on(ModalEvents.save,(function(evt){let textarea=document.getElementById("modifiedcalc");evt.isDefaultPrevented=function(){return!0},Ajax.call([{methodname:"gradereport_calcsetup_validatecalc",args:{id:itemid,courseid:courseid,formula:textarea.value},done:function(data){!0===data.valid?(document.getElementById("newcalcview").innerHTML=textarea.value,document.getElementById("newcalc").value=textarea.value.replace(/\n/g,""),modal.hide()):(null!==textarea.previousElementSibling&&textarea.previousElementSibling.remove(),Str.get_string("formulaerror","gradereport_calcsetup").then((function(s){let warning=document.createElement("p"),body=textarea.parentNode;return warning.setAttribute("class","bad-calc"),warning.innerHTML=s,body.insertBefore(warning,textarea),!0})).fail(_notification.default.exception))},fail:_notification.default.exception}])})),modal.getRoot().on(ModalEvents.hidden,(function(){document.getElementById("modifiedcalc").remove()})),modal.show(),modal}))},changeRule=evt=>{evt.preventDefault();let ruleid=evt.target.dataset.ruleid||0,actionurl=evt.target.getAttribute("href");return ModalFactory.create({type:ModalFactory.types.SAVE_CANCEL,body:"",title:Str.get_string("rule","gradereport_calcsetup"),removeOnClose:!0}).then((function(modal){return modal.modal[0].addEventListener("change",showrule),modal.getRoot().on(ModalEvents.save,(function(){document.getElementById("categoryruleform").submit()})),Ajax.call([{methodname:"gradereport_calcsetup_getrules",args:{id:ruleid},done:function(data){data.actionurl=actionurl,Templates.renderForPromise("gradereport_calcsetup/ruleselector",data).then((_ref=>{let{html:html,js:js}=_ref;return Templates.appendNodeContents(".modal-body",html,js),!0})).catch(_notification.default.exception)}}]),modal.show(),!0}))},showrule=evt=>{let d=evt.target.dataset.description;document.getElementById("ruledescription").innerHTML=d}}));

//# sourceMappingURL=calcsetup.min.js.map