define("gradereport_calcsetup/editrule",["exports","core/modal_factory","core/modal_events","core/str","core/templates","core/notification","core/ajax"],(function(_exports,ModalFactory,ModalEvents,Str,Templates,_notification,Ajax){var obj;function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!==_typeof(obj)&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}return newObj.default=obj,cache&&cache.set(obj,newObj),newObj}function _typeof(obj){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj},_typeof(obj)}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,ModalFactory=_interopRequireWildcard(ModalFactory),ModalEvents=_interopRequireWildcard(ModalEvents),Str=_interopRequireWildcard(Str),Templates=_interopRequireWildcard(Templates),_notification=(obj=_notification)&&obj.__esModule?obj:{default:obj},Ajax=_interopRequireWildcard(Ajax);_exports.init=function(){document.querySelector(".rule-fields").parentElement.addEventListener("click",editrule),document.querySelector(".rule-cols").parentElement.addEventListener("click",editrule),document.querySelector(".rule-actions").parentElement.addEventListener("click",editaction),document.querySelector(".loophelper").addEventListener("click",loopHelper)};var editrule=function(evt){var el=evt.target;if("I"===el.nodeName){evt.preventDefault();var row=el.closest("div"),container=row.parentNode,index=parseInt(row.dataset.index),field=document.querySelector("input[name="+row.dataset.targetele+"]"),columns=JSON.parse(field.value),action=el.dataset.action;if("up"===action){var oldfield=columns[index-1];return columns[index-1]=columns[index],columns[index]=oldfield,row.dataset.index=index-1,row.previousSibling.dataset.index=index,container.insertBefore(row,row.previousSibling),field.value=JSON.stringify(columns),!0}if("down"===action){var _oldfield=columns[index+1];return columns[index+1]=columns[index],columns[index]=_oldfield,row.dataset.index=index+1,row.nextSibling.dataset.index=index,container.insertBefore(row.nextSibling,row),field.value=JSON.stringify(columns),!0}if("delete"===action){columns.splice(index,1);for(var i=index;i<container.children.length;i++)container.children[i].dataset.index=container.children[i].dataset.index-1;return row.remove(),field.value=JSON.stringify(columns),!0}if("edit"===action){var title="fields"===row.dataset.targetele?Str.get_string("editfield","gradereport_calcsetup"):Str.get_string("editcols","gradereport_calcsetup");ModalFactory.create({type:ModalFactory.types.SAVE_CANCEL,body:"",title:title,removeOnClose:!0}).then((function(modal){return modal.getRoot().on("change",swapSelect),modal.getRoot().on(ModalEvents.save,{columns:columns,row:row,index:index,field:field},saveFields),modal.getRoot().on(ModalEvents.hidden,(function(){modal.destroy()})),Ajax.call([{methodname:"gradereport_calcsetup_get_corefields",args:{editableonly:!1},done:function(data){data.col=columns[index],Str.get_string("free","gradereport_calcsetup").done((function(string){data.exists=index<columns.length;var prop=data.exists?data.col.property:null;data.fields=getCorefields(data.fields,prop,string),void 0!==data.col&&("object"===_typeof(columns[index].title)?(data.title=columns[index].title.identifier,data.component=columns[index].title.component):data.title=columns[index].title),Templates.renderForPromise("gradereport_calcsetup/editfield",data).then((function(_ref){var html=_ref.html,js=_ref.js;return Templates.appendNodeContents(".modal-body",html,js),!0})).catch(_notification.default.exception)})),modal.show()}}]),!0})).catch(_notification.default.exception)}return!1}},editaction=function(evt){var el=evt.target;if("I"===el.nodeName){evt.preventDefault();var row=el.closest("div"),container=row.parentNode,index=parseInt(row.dataset.index),field=document.querySelector("input[name=actions]"),actions=JSON.parse(field.value),action=el.dataset.action;if("up"===action){var oldfield=actions[index-1];return actions[index-1]=actions[index],actions[index]=oldfield,row.dataset.index=index-1,row.previousSibling.dataset.index=index,container.insertBefore(row,row.previousSibling),void(field.value=JSON.stringify(actions))}if("down"===action){var _oldfield2=actions[index+1];return actions[index+1]=actions[index],actions[index]=_oldfield2,row.dataset.index=index+1,row.nextSibling.dataset.index=index,container.insertBefore(row.nextSibling,row),void(field.value=JSON.stringify(actions))}if("edit"===action&&ModalFactory.create({type:ModalFactory.types.SAVE_CANCEL,body:"",title:Str.get_string("editaction","gradereport_calcsetup"),removeOnClose:!0}).then((function(modal){return modal.getRoot().on(ModalEvents.hidden,(function(){modal.destroy()})),modal.getRoot().on("change",swapSelect),modal.getRoot().on(ModalEvents.save,(function(){index===actions.length&&(actions.push({op:"equals"}),row.parentElement.appendChild(row.cloneNode(!0)).dataset.index=index+1,row.querySelector("span:last-of-type").innerHTML="<a class='up' href='#'><i class='icon fa fa-arrow-up fa-fw ' title='$strup' aria-label='$strup' data-action='up'></i></a><a class='down' href='#'><i class='icon fa fa-arrow-down fa-fw ' title='$strdn' aria-label='$strdn' data-action='down'></i></a><a href=\"#\"><i class=\"icon fa fa-trash fa-fw\" title=\"Delete\" aria-label=\"Delete\" data-action=\"delete\"></i></a><a href=\"#\" ><i class=\"icon fa fa-cog fa-fw\" title=\"Edit\" aria-label=\"Edit\" data-action=\"edit\"></i></a>");actions[index].set=document.getElementById("actionset").value,actions[index].to=document.getElementById("actionto").value,actions[index].when=document.getElementById("actionwhen").value,actions[index].op="equals",actions[index].val=document.getElementById("actionval").value,field.value=JSON.stringify(actions);var operator=Str.get_string(actions[index].op,"gradereport_calcsetup",actions[index]),astring="action";""===actions[index].val&&(astring="actionall"),operator.done((function(string){actions[index].op=string,Str.get_string(astring,"gradereport_calcsetup",actions[index]).done((function(string){row.querySelector("span:first-of-type").innerHTML=string}))}))})),Ajax.call([{methodname:"gradereport_calcsetup_get_corefields",args:{editableonly:!1},done:function(data){Str.get_string("free","gradereport_calcsetup").done((function(string){var actionrow={};actionrow.action=index<actions.length?actions[index]:[],actionrow.exists=index<actions.length,actionrow.fields=getCorefields(data.fields,actionrow.exists?actions[index].set:null,string),actionrow.fieldswhen=getCorefields(data.fields,actionrow.exists?actions[index].when:null,string),Templates.renderForPromise("gradereport_calcsetup/editaction",actionrow).then((function(_ref2){var html=_ref2.html,js=_ref2.js;return Templates.appendNodeContents(".modal-body",html,js),!0})).catch(_notification.default.exception)})),modal.show()}}]),!0})).catch(_notification.default.exception),"delete"===action){actions.splice(index,1);for(var i=index;i<container.children.length;i++)container.children[i].dataset.index=container.children[i].dataset.index-1;row.remove(),field.value=JSON.stringify(actions)}}},swapSelect=function(e){if("actionwhen"===e.target.getAttribute("id")){var valInput=document.getElementById("actionval");"all"!==e.target.value?valInput.removeAttribute("disabled"):valInput.setAttribute("disabled","disabled")}if("free"===e.target.value){var input=document.createElement("input");input.setAttribute("id",e.target.getAttribute("id")),e.target.parentElement.insertBefore(input,e.target),e.target.remove()}},saveFields=function(e){var columns=e.data.columns,row=e.data.row,index=e.data.index,field=e.data.field;void 0===columns[index]&&(columns[index]={},row.parentElement.appendChild(row.cloneNode(!0)).dataset.index=index+1,row.querySelector("span:last-of-type").innerHTML="<a class='up' href='#'><i class='icon fa fa-arrow-up fa-fw ' title='$strup' aria-label='$strup' data-action='up'></i></a><a class='down' href='#'><i class='icon fa fa-arrow-down fa-fw ' title='$strdn' aria-label='$strdn' data-action='down'></i></a><a class='delete' href='#'><i class='icon fa fa-trash fa-fw ' title='$strdel' aria-label='$strdel' data-action='delete'></i></a><a class='edit' href='#'><i class='icon fa fa-cog fa-fw ' title='$stredit' aria-label='$stredit' data-action='edit'></i></a>");var reqStrings=[{key:"editable",component:"gradereport_calcsetup"},{key:"locked",component:"gradereport_calcsetup"}],title=document.getElementById("coltitle").value,component=document.getElementById("titlecomp").value;columns[index].title={identifier:title,component:component},columns[index].property=document.getElementById("colproperty").value,columns[index].editable=document.getElementById("coleditable").checked,reqStrings.push({key:columns[index].title.identifier,component:columns[index].title.component}),Str.get_strings(reqStrings).done((function(strings){/^\[\[.+\]\]$/.test(strings[2])?(columns[index].title=title,row.querySelector("span:first-of-type").innerHTML=title):row.querySelector("span:first-of-type").innerHTML=strings[2],row.querySelector("span:nth-of-type(2)").innerHTML=columns[index].property,row.querySelector("span:nth-of-type(3)").innerHTML=columns[index].editable?strings[0]:strings[1],field.value=JSON.stringify(columns)}))},getCorefields=function(data,property,string){var dataString=JSON.stringify(data),giProperties=JSON.parse(dataString),l=giProperties.push({property:"free"});if("string"==typeof property){var i;for(i=0;i<l;i++)if(giProperties[i].property===property){giProperties[i].selected=!0;break}i===l&&giProperties.push({property:property,selected:!0})}return giProperties[l-1].property=string,giProperties[l-1].value="free",giProperties},loopHelper=function(evt){return evt.preventDefault(),ModalFactory.create({type:ModalFactory.types.DEFAULT,body:"",title:Str.get_string("loophelper","gradereport_calcsetup"),removeOnClose:!1}).then((function(modal){return modal.getRoot().on("change",updateCalc),Ajax.call([{methodname:"gradereport_calcsetup_get_corefields",args:{editableonly:!1},done:function(data){Templates.renderForPromise("gradereport_calcsetup/looper",data).then((function(_ref3){var html=_ref3.html,js=_ref3.js;Templates.appendNodeContents(".modal-body",html,js);var copyBtn=modal.getRoot()[0].querySelector(".copyme");return navigator.clipboard?copyBtn.addEventListener("click",(function(e){var copyText=e.target.previousElementSibling;copyText.select(),copyText.setSelectionRange(0,99999),navigator.clipboard.writeText(copyText.value)})):copyBtn.setAttribute("style","display:none"),!0})).catch(_notification.default.exception)}}]),modal.show(),!0}))},updateCalc=function(evt){var container=evt.target.closest(".modal-body"),group=container.querySelector("#loopgroup").value,contentInput=container.querySelector("#loopcontent"),separator=container.querySelector("#loopseparator").value;return"loopproperty"===evt.target.getAttribute("id")&&(contentInput.value=contentInput.value+"{{"+evt.target.value+"}}"),""===evt.target.getAttribute("id")||(container.querySelector(".output").value="{{#"+group+"}}"+contentInput.value+"{{^last}}"+separator+"{{/last}}{{/"+group+"}}"),!0}}));

//# sourceMappingURL=editrule.min.js.map