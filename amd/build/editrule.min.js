define ("gradereport_calcsetup/editrule",["exports","core/modal_factory","core/modal_events","core/str","core/templates","core/notification","core/ajax"],function(a,b,c,d,e,f,g){"use strict";Object.defineProperty(a,"__esModule",{value:!0});a.init=void 0;b=i(b);c=i(c);d=i(d);e=i(e);f=function(a){return a&&a.__esModule?a:{default:a}}(f);g=i(g);function h(){if("function"!=typeof WeakMap)return null;var a=new WeakMap;h=function(){return a};return a}function i(a){if(a&&a.__esModule){return a}if(null===a||"object"!==j(a)&&"function"!=typeof a){return{default:a}}var b=h();if(b&&b.has(a)){return b.get(a)}var c={},d=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var e in a){if(Object.prototype.hasOwnProperty.call(a,e)){var f=d?Object.getOwnPropertyDescriptor(a,e):null;if(f&&(f.get||f.set)){Object.defineProperty(c,e,f)}else{c[e]=a[e]}}}c.default=a;if(b){b.set(a,c)}return c}function j(a){"@babel/helpers - typeof";if("function"==typeof Symbol&&"symbol"==typeof Symbol.iterator){j=function(a){return typeof a}}else{j=function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a}}return j(a)}a.init=function init(){document.querySelector(".rule-fields").parentElement.addEventListener("click",k);document.querySelector(".rule-cols").parentElement.addEventListener("click",k);document.querySelector(".rule-actions").parentElement.addEventListener("click",l);document.querySelector(".loophelper").addEventListener("click",q)};var k=function(a){var h=a.target;if("I"!==h.nodeName){return}a.preventDefault();var k=h.closest("div"),l=k.parentNode,o=parseInt(k.dataset.index),q=document.querySelector("input[name="+k.dataset.targetele+"]"),r=JSON.parse(q.value),s=h.dataset.action;if("up"===s){var t=r[o-1];r[o-1]=r[o];r[o]=t;k.dataset.index=o-1;k.previousSibling.dataset.index=o;l.insertBefore(k,k.previousSibling);q.value=JSON.stringify(r);return}if("down"===s){var u=r[o+1];r[o+1]=r[o];r[o]=u;k.dataset.index=o+1;k.nextSibling.dataset.index=o;l.insertBefore(k.nextSibling,k);q.value=JSON.stringify(r);return}if("delete"===s){r.splice(o,1);for(var v=o;v<l.children.length;v++){l.children[v].dataset.index=l.children[v].dataset.index-1}k.remove();q.value=JSON.stringify(r);return}if("edit"===s){var i="fields"===k.dataset.targetele?d.get_string("editfield","gradereport_calcsetup"):d.get_string("editcols","gradereport_calcsetup");b.create({type:b.types.SAVE_CANCEL,body:"",title:i,removeOnClose:!0}).then(function(a){a.getRoot().on("change",m);a.getRoot().on(c.save,{columns:r,row:k,index:o,field:q},n);a.getRoot().on(c.hidden,function(){a.destroy()});g.call([{methodname:"gradereport_calcsetup_get_corefields",args:{editableonly:!1},done:function done(b){b.col=r[o];var c=d.get_string("free","gradereport_calcsetup");c.done(function(a){b.exists=o<r.length;var c=b.exists?b.col.property:null;b.fields=p(b.fields,c,a);if("undefined"!=typeof b.col){b.title="object"===j(r[o].title)?JSON.stringify(r[o].title):r[o].title}e.renderForPromise("gradereport_calcsetup/editfield",b).then(function(a){var b=a.html,c=a.js;e.appendNodeContents(".modal-body",b,c);return!0}).catch(f.default.exception)});a.show()}}]);return!0})}},l=function(a){var h=a.target;if("I"!==h.nodeName){return}a.preventDefault();var j=h.closest("div"),k=j.parentNode,l=parseInt(j.dataset.index),n=document.querySelector("input[name=actions]"),o=JSON.parse(n.value),q=h.dataset.action;if("edit"===q){b.create({type:b.types.SAVE_CANCEL,body:"",title:d.get_string("editaction","gradereport_calcsetup"),removeOnClose:!0}).then(function(a){a.getRoot().on("change",m);a.getRoot().on(c.save,function(){if(l===o.length){o.push({op:"equals"});var b=j.parentElement.appendChild(j.cloneNode(!0));b.dataset.index=l+1;j.querySelector("span:last-of-type").innerHTML="<a href=\"#\"><i class=\"icon fa fa-trash fa-fw\" title=\"Delete\" aria-label=\"Delete\" data-action=\"delete\"></i></a><a href=\"#\" ><i class=\"icon fa fa-cog fa-fw\" title=\"Edit\" aria-label=\"Edit\" data-action=\"edit\"></i></a>"}o[l].set=document.getElementById("actionset").value;o[l].to=document.getElementById("actionto").value;o[l].when=document.getElementById("actionwhen").value;o[l].val=document.getElementById("actionval").value;n.value=JSON.stringify(o);var a=d.get_string(o[l].op,"gradereport_calcsetup",o[l]);a.done(function(a){o[l].op=a;var b=d.get_string("action","gradereport_calcsetup",o[l]);b.done(function(a){j.querySelector("span:first-of-type").innerHTML=a})})});g.call([{methodname:"gradereport_calcsetup_get_corefields",args:{editableonly:!0},done:function done(b){var c=d.get_string("free","gradereport_calcsetup");c.done(function(a){var c={action:l<o.length?o[l]:[],exists:l<o.length};c.fields=p(b.fields,c.exists?o[l].set:null,a);c.fieldswhen=p(b.fields,c.exists?o[l].when:null,a);e.renderForPromise("gradereport_calcsetup/editaction",c).then(function(a){var b=a.html,c=a.js;e.appendNodeContents(".modal-body",b,c);return!0}).catch(f.default.exception)});a.show()}}]);return!0})}if("delete"===q){o.splice(l,1);for(var r=l;r<k.children.length;r++){k.children[r].dataset.index=k.children[r].dataset.index-1}j.remove();n.value=JSON.stringify(o)}},m=function(a){if("free"===a.target.value){var b=document.createElement("input");b.setAttribute("id",a.target.getAttribute("id"));a.target.parentElement.insertBefore(b,a.target);a.target.remove()}},n=function(a){var b=a.data.columns,c=a.data.row,e=a.data.index,f=a.data.field;if("undefined"==typeof b[e]){b[e]={};var i=c.parentElement.appendChild(c.cloneNode(!0));i.dataset.index=e+1;c.querySelector("span:last-of-type").innerHTML="<a class='up' href='#'><i class='icon fa fa-arrow-up fa-fw ' title='$strup' aria-label='$strup' data-action='up'></i></a><a class='down' href='#'><i class='icon fa fa-arrow-down fa-fw ' title='$strdn' aria-label='$strdn' data-action='down'></i></a><a class='delete' href='#'><i class='icon fa fa-trash fa-fw ' title='$strdel' aria-label='$strdel' data-action='delete'></i></a><a class='edit' href='#'><i class='icon fa fa-cog fa-fw ' title='$stredit' aria-label='$stredit' data-action='edit'></i></a>"}var g=[{key:"editable",component:"gradereport_calcsetup"},{key:"locked",component:"gradereport_calcsetup"}];b[e].title=o(document.getElementById("coltitle").value);b[e].property=document.getElementById("colproperty").value;b[e].editable=document.getElementById("coleditable").checked;if("object"===j(b[e].title)){g.push({key:b[e].title.identifier,component:b[e].title.component})}var h=d.get_strings(g);h.done(function(a){c.querySelector("span:first-of-type").innerHTML="object"===j(b[e].title)?a[2]:b[e].title;c.querySelector("span:nth-of-type(2)").innerHTML=b[e].property;c.querySelector("span:nth-of-type(3)").innerHTML=b[e].editable?a[0]:a[1]});f.value=JSON.stringify(b)},o=function(a){try{var b=JSON.parse(a);if(b&&"object"===j(b)){return b}}catch(a){}return a},p=function(a,b,c){var d=JSON.stringify(a),e=JSON.parse(d),f=e.push({property:"free"});if("string"==typeof b){var g;for(g=0;g<f;g++){if(e[g].property===b){e[g].selected=!0;break}}if(g===f){e.push({property:b,selected:!0})}}e[f-1].property=c;e[f-1].value="free";return e},q=function(a){a.preventDefault();return b.create({type:b.types.DEFAULT,body:"",title:d.get_string("loophelper","gradereport_calcsetup"),removeOnClose:!1}).then(function(a){a.getRoot().on("change",r);g.call([{methodname:"gradereport_calcsetup_get_corefields",args:{editableonly:!1},done:function done(b){e.renderForPromise("gradereport_calcsetup/looper",b).then(function(b){var c=b.html,d=b.js;e.appendNodeContents(".modal-body",c,d);var f=a.getRoot()[0].querySelector(".copyme");if(navigator.clipboard){f.addEventListener("click",function(a){var b=a.target.previousElementSibling;b.select();b.setSelectionRange(0,99999);navigator.clipboard.writeText(b.value)})}else{f.setAttribute("style","display:none")}return!0}).catch(f.default.exception)}}]);a.show();return!0})},r=function(a){var b=a.target.closest(".modal-body"),c=b.querySelector("#loopgroup").value,d=b.querySelector("#loopcontent"),e=b.querySelector("#loopseparator").value;if("loopproperty"===a.target.getAttribute("id")){d.value=d.value+"{{"+a.target.value+"}}"}if(""===a.target.getAttribute("id")){return!0}else{b.querySelector(".output").value="{{#"+c+"}}"+d.value+"{{^last}}"+e+"{{/last}}{{/"+c+"}}"}return!0}});
//# sourceMappingURL=editrule.min.js.map
