{"version":3,"sources":["../src/editrule.js"],"names":["init","document","querySelector","parentElement","addEventListener","editrule","evt","el","target","nodeName","preventDefault","columns","JSON","parse","value","action","dataset","row","closest","container","parentNode","index","parseInt","oldfield","previousSibling","insertBefore","stringify","nextSibling","splice","i","children","length","remove","ModalFactory","create","type","types","SAVE_CANCEL","body","title","Str","get_string","removeOnClose","buttons","save","cancel","then","modal","getRoot","on","ModalEvents","addrow","appendChild","cloneNode","innerHTML","reqStrings","tryParseJSONObject","getElementById","property","editable","checked","push","identifier","component","stringsPromise","get_strings","done","strings","Ajax","call","methodname","args","data","col","fields","selected","Templates","renderForPromise","html","js","appendNodeContents","catch","Notification","exception","show","jsonString","o","e"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * @file       UI scripts for Grade Calculation Setup Tool.\n * @copyright  Te Wānanga o Aotearoa\n * @author     Jeremy FitzPatrick\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport * as ModalFactory from \"core/modal_factory\";\nimport * as ModalEvents from \"core/modal_events\";\nimport * as Str from \"core/str\";\nimport * as Templates from \"core/templates\";\nimport Notification from \"core/notification\";\nimport * as Ajax from \"core/ajax\";\n\nexport const init = () => {\n    document.querySelector(\".rule-field\").parentElement.addEventListener(\"click\", editrule);\n};\n\n/**\n * Decide which edit button was pressed\n * @param {Event} evt\n */\nconst editrule = (evt) => {\n    let el = evt.target;\n\n    if (el.nodeName !== \"I\") {\n        return;\n    }\n    evt.preventDefault();\n\n    let columns = JSON.parse(document.querySelector(\"input[name=cols]\").value);\n    let action = el.dataset.action;\n    let row = el.closest(\"div\");\n    let container = row.parentNode;\n    let index = parseInt(row.dataset.index);\n\n    if (action === \"up\") {\n        let oldfield = columns[index - 1];\n        columns[index - 1] = columns[index];\n        columns[index] = oldfield;\n\n        row.dataset.index = index - 1;\n        row.previousSibling.dataset.index = index;\n        container.insertBefore(row, row.previousSibling);\n\n        document.querySelector(\"input[name=cols]\").value = JSON.stringify(columns);\n        return;\n    }\n\n    if (action === \"down\") {\n        let oldfield = columns[index + 1];\n        columns[index + 1] = columns[index];\n        columns[index] = oldfield;\n\n        row.dataset.index = index + 1;\n        row.nextSibling.dataset.index = index;\n        container.insertBefore(row.nextSibling, row);\n\n        document.querySelector(\"input[name=cols]\").value = JSON.stringify(columns);\n        return;\n    }\n\n    if (action === \"delete\") {\n        columns.splice(index, 1);\n        for (var i = index; i < container.children.length; i++) {\n            container.children[i].dataset.index = container.children[i].dataset.index - 1;\n        }\n        row.remove();\n        document.querySelector(\"input[name=cols]\").value = JSON.stringify(columns);\n        return;\n    }\n\n    if (action === \"edit\") {\n        return ModalFactory.create({\n            type: ModalFactory.types.SAVE_CANCEL,\n            body: \"\",\n            title: Str.get_string(\"deleterule\", \"gradereport_calcsetup\"),\n            removeOnClose: true,\n            buttons: {\n                save: Str.get_string(\"yes\"),\n                cancel: Str.get_string(\"no\"),\n            }\n        }).then(function(modal) {\n            modal.getRoot().on(ModalEvents.save, function() {\n                if (typeof columns[index] === 'undefined') {\n                    columns[index] = {};\n                    let addrow = row.parentElement.appendChild(row.cloneNode(true));\n                    addrow.dataset.index = index + 1;\n                    row.querySelector(\"span:last-of-type\").innerHTML =\n                        \"<a class='up' href='#'>\" +\n                        \"<i class='icon fa fa-arrow-up fa-fw ' title='$strup' aria-label='$strup' data-action='up'></i>\" +\n                        \"</a><a class='down' href='#'>\" +\n                        \"<i class='icon fa fa-arrow-down fa-fw ' title='$strdn' aria-label='$strdn' data-action='down'></i>\" +\n                        \"</a><a class='delete' href='#'>\" +\n                        \"<i class='icon fa fa-trash fa-fw ' title='$strdel' aria-label='$strdel' data-action='delete'></i>\" +\n                        \"</a><a class='edit' href='#'>\" +\n                        \"<i class='icon fa fa-cog fa-fw ' title='$stredit' aria-label='$stredit' data-action='edit'></i></a>\";\n                }\n                var reqStrings = [\n                    {\"key\": \"editable\", \"component\": \"gradereport_calcsetup\"},\n                    {\"key\": \"locked\", \"component\": \"gradereport_calcsetup\"},\n                ];\n\n                // Set the data.\n                columns[index].title = tryParseJSONObject(document.getElementById(\"coltitle\").value);\n                columns[index].property = document.getElementById(\"colproperty\").value;\n                columns[index].editable = document.getElementById(\"coleditable\").checked;\n                // Set the dom.\n                if (typeof columns[index].title === \"object\") {\n                    reqStrings.push({\n                        \"key\": columns[index].title.identifier,\n                        \"component\": columns[index].title.component\n                    });\n                }\n\n                var stringsPromise = Str.get_strings(reqStrings);\n                stringsPromise.done(function(strings) {\n                    row.querySelector(\"span:first-of-type\").innerHTML = typeof columns[index].title === \"object\"\n                        ? strings[2]\n                        : columns[index].title;\n                    row.querySelector(\"span:nth-of-type(2)\").innerHTML = columns[index].property;\n                    row.querySelector(\"span:nth-of-type(3)\").innerHTML = columns[index].editable\n                        ? strings[0]\n                        : strings[1];\n                });\n                document.querySelector(\"input[name=cols]\").value = JSON.stringify(columns);\n                //modal.destroy();\n            });\n            Ajax.call([{\n                methodname: \"gradereport_calcsetup_get_corefields\",\n                args: {},\n                done: function(data) {\n                    data.col = columns[index];\n                    if (typeof data.col !== 'undefined') {\n                        for (var i = 0; i < data.fields.length; i++) {\n                            if (data.fields[i].property == data.col.property) {\n                                data.fields[i].selected = true;\n                            }\n                        }\n\n                        data.title = typeof columns[index].title === \"object\"\n                            ? JSON.stringify(columns[index].title)\n                            : columns[index].title;\n                    }\n                    Templates.renderForPromise(\"gradereport_calcsetup/editfield\", data)\n                        .then(({html, js}) => {\n                            Templates.appendNodeContents(\".modal-body\", html, js);\n                            return true;\n                        })\n                        .catch(Notification.exception);\n                    modal.show();\n                }\n            }]);\n\n            return true;\n        });\n        evt.preventDefault();\n    }\n};\n\nconst tryParseJSONObject = (jsonString) => {\n    try {\n        var o = JSON.parse(jsonString);\n        if (o && typeof o === \"object\") {\n            return o;\n        }\n    }\n    catch (e) { }\n\n    return jsonString;\n};\n"],"file":"editrule.min.js"}