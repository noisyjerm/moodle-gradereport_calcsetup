{"version":3,"sources":["../src/editrule.js"],"names":["init","document","querySelector","parentElement","addEventListener","editrule","evt","el","target","nodeName","preventDefault","row","closest","container","parentNode","index","parseInt","dataset","field","targetele","columns","JSON","parse","value","action","oldfield","previousSibling","insertBefore","stringify","nextSibling","splice","i","children","length","remove","ModalFactory","create","type","types","SAVE_CANCEL","body","title","Str","get_string","removeOnClose","then","modal","getRoot","on","ModalEvents","save","addrow","appendChild","cloneNode","innerHTML","reqStrings","tryParseJSONObject","getElementById","property","editable","checked","push","identifier","component","stringsPromise","get_strings","done","strings","hidden","destroy","Ajax","call","methodname","args","data","col","string","l","fields","exists","selected","Templates","renderForPromise","html","js","appendNodeContents","e","input","createElement","setAttribute","getAttribute","catch","Notification","exception","show","jsonString","o"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * @file       UI scripts for Grade Calculation Setup Tool.\n * @copyright  Te Wānanga o Aotearoa\n * @author     Jeremy FitzPatrick\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport * as ModalFactory from \"core/modal_factory\";\nimport * as ModalEvents from \"core/modal_events\";\nimport * as Str from \"core/str\";\nimport * as Templates from \"core/templates\";\nimport Notification from \"core/notification\";\nimport * as Ajax from \"core/ajax\";\n\nexport const init = () => {\n    document.querySelector(\".rule-fields\").parentElement.addEventListener(\"click\", editrule);\n    document.querySelector(\".rule-cols\").parentElement.addEventListener(\"click\", editrule);\n};\n\n/**\n * Decide which edit button was pressed\n * @param {Event} evt\n */\nconst editrule = (evt) => {\n    let el = evt.target;\n\n    if (el.nodeName !== \"I\") {\n        return;\n    }\n    evt.preventDefault();\n\n    let row = el.closest(\"div\");\n    let container = row.parentNode;\n    let index = parseInt(row.dataset.index);\n    var field = document.querySelector(\"input[name=\" + row.dataset.targetele + \"]\");\n    let columns = JSON.parse(field.value);\n    let action = el.dataset.action;\n\n    if (action === \"up\") {\n        let oldfield = columns[index - 1];\n        columns[index - 1] = columns[index];\n        columns[index] = oldfield;\n\n        row.dataset.index = index - 1;\n        row.previousSibling.dataset.index = index;\n        container.insertBefore(row, row.previousSibling);\n\n        field.value = JSON.stringify(columns);\n        return;\n    }\n\n    if (action === \"down\") {\n        let oldfield = columns[index + 1];\n        columns[index + 1] = columns[index];\n        columns[index] = oldfield;\n\n        row.dataset.index = index + 1;\n        row.nextSibling.dataset.index = index;\n        container.insertBefore(row.nextSibling, row);\n\n        field.value = JSON.stringify(columns);\n        return;\n    }\n\n    if (action === \"delete\") {\n        columns.splice(index, 1);\n        for (var i = index; i < container.children.length; i++) {\n            container.children[i].dataset.index = container.children[i].dataset.index - 1;\n        }\n        row.remove();\n        field.value = JSON.stringify(columns);\n        return;\n    }\n\n    if (action === \"edit\") {\n        return ModalFactory.create({\n            type: ModalFactory.types.SAVE_CANCEL,\n            body: \"\",\n            title: Str.get_string(\"editfield\", \"gradereport_calcsetup\"),\n            removeOnClose: true\n        }).then(function(modal) {\n            modal.getRoot().on(ModalEvents.save, function() {\n                if (typeof columns[index] === 'undefined') {\n                    columns[index] = {};\n                    let addrow = row.parentElement.appendChild(row.cloneNode(true));\n                    addrow.dataset.index = index + 1;\n                    row.querySelector(\"span:last-of-type\").innerHTML =\n                        \"<a class='up' href='#'>\" +\n                        \"<i class='icon fa fa-arrow-up fa-fw ' title='$strup' aria-label='$strup' data-action='up'></i>\" +\n                        \"</a><a class='down' href='#'>\" +\n                        \"<i class='icon fa fa-arrow-down fa-fw ' title='$strdn' aria-label='$strdn' data-action='down'></i>\" +\n                        \"</a><a class='delete' href='#'>\" +\n                        \"<i class='icon fa fa-trash fa-fw ' title='$strdel' aria-label='$strdel' data-action='delete'></i>\" +\n                        \"</a><a class='edit' href='#'>\" +\n                        \"<i class='icon fa fa-cog fa-fw ' title='$stredit' aria-label='$stredit' data-action='edit'></i></a>\";\n                }\n                var reqStrings = [\n                    {\"key\": \"editable\", \"component\": \"gradereport_calcsetup\"},\n                    {\"key\": \"locked\", \"component\": \"gradereport_calcsetup\"}\n                ];\n\n                // Set the data.\n                columns[index].title = tryParseJSONObject(document.getElementById(\"coltitle\").value);\n                columns[index].property = document.getElementById(\"colproperty\").value;\n                columns[index].editable = document.getElementById(\"coleditable\").checked;\n                // Set the dom.\n                if (typeof columns[index].title === \"object\") {\n                    reqStrings.push({\n                        \"key\": columns[index].title.identifier,\n                        \"component\": columns[index].title.component\n                    });\n                }\n\n                var stringsPromise = Str.get_strings(reqStrings);\n                stringsPromise.done(function(strings) {\n                    row.querySelector(\"span:first-of-type\").innerHTML = typeof columns[index].title === \"object\"\n                        ? strings[2]\n                        : columns[index].title;\n                    row.querySelector(\"span:nth-of-type(2)\").innerHTML = columns[index].property;\n                    row.querySelector(\"span:nth-of-type(3)\").innerHTML = columns[index].editable\n                        ? strings[0]\n                        : strings[1];\n                });\n                field.value = JSON.stringify(columns);\n            });\n            modal.getRoot().on(ModalEvents.hidden, function() {\n                modal.destroy();\n            });\n            Ajax.call([{\n                methodname: \"gradereport_calcsetup_get_corefields\",\n                args: {},\n                done: function(data) {\n                    data.col = columns[index];\n                    let stringsPromise = Str.get_string(\"free\", \"gradereport_calcsetup\");\n                    stringsPromise.done(function(string) {\n                        let l = data.fields.push({\"property\": \"free\"});\n                        if (typeof data.col !== 'undefined') {\n                            data.exists = true;\n                            for (var i = 0; i < l; i++) {\n                                if (data.fields[i].property == data.col.property) {\n                                    data.fields[i].selected = true;\n                                    break;\n                                }\n                            }\n                            if (i === l) {\n                                data.fields.push({\"property\": data.col.property, \"selected\": true});\n                            }\n\n                            data.title = typeof columns[index].title === \"object\"\n                                ? JSON.stringify(columns[index].title)\n                                : columns[index].title;\n                        }\n                        // Replace the last item \"free\" with a readable name.\n                        data.fields[l-1].property = string;\n                        data.fields[l-1].value = \"free\";\n                        Templates.renderForPromise(\"gradereport_calcsetup/editfield\", data)\n                            .then(({html, js}) => {\n                                Templates.appendNodeContents(\".modal-body\", html, js);\n                                document.getElementById(\"colproperty\").addEventListener(\"change\", function (e) {\n                                    if (e.target.value === \"free\") {\n                                        let input = document.createElement(\"input\");\n                                        input.setAttribute(\"id\", e.target.getAttribute(\"id\"));\n                                        e.target.parentElement.insertBefore(input, e.target);\n                                        e.target.remove();\n                                    }\n                                });\n                                return true;\n                            })\n                            .catch(Notification.exception);\n                    });\n                    modal.show();\n                }\n            }]);\n\n            return true;\n        });\n        evt.preventDefault();\n    }\n};\n\nconst tryParseJSONObject = (jsonString) => {\n    try {\n        var o = JSON.parse(jsonString);\n        if (o && typeof o === \"object\") {\n            return o;\n        }\n    }\n    catch (e) { }\n\n    return jsonString;\n};\n"],"file":"editrule.min.js"}